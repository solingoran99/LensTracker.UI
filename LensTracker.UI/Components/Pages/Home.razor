@page "/"
@inject IJSRuntime JS
@inject DateService DateService

<div class="calendar-wrapper" @onclick="ResetToToday">

    <div class="glow-beam"></div>

    <div class="wheel-container"
         @onscroll="OnScroll"
         @ref="WheelRef"
         @onclick:stopPropagation="true">

        <div style="height:180px"></div>

        @foreach (var day in Days)
        {
            string css =
            day == Today ? "today" :
            day == SelectedDay ? "active" : "";

            <div class="wheel-item @css"
                 @onclick="() => SelectDay(day)">
                @day
            </div>
        }

        <div style="height:180px"></div>
    </div>

    <div class="start-bubble">
        <button class="start-button" @onclick="StartSession">Log Session</button>
    </div>

</div>

@code {
    ElementReference WheelRef;

    List<int> Days = Enumerable.Range(1, 31).ToList();
    int Today = 1;
    int SelectedDay = 1;

    const int ItemHeight = 60;
    const int PadHeight = 180;
    const int ContainerCenter = 210;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            Today = await JS.InvokeAsync<int>("getClientDate");
            SelectedDay = Today;

            DateService.SetDay(SelectedDay);
            await ScrollToDay(SelectedDay);
        }
    }

    async Task ScrollToDay(int day)
    {
        int index = day - 1;
        int scrollPos =
            PadHeight +
            (index * ItemHeight) -
            (ContainerCenter - (ItemHeight / 2));

        await JS.InvokeVoidAsync("scrollToDay", WheelRef, scrollPos);
    }

    void SelectDay(int day)
    {
        SelectedDay = day;
        DateService.SetDay(day);
    }

    async void OnScroll()
    {
        double scrollTop = await JS.InvokeAsync<double>("getScrollTop", WheelRef);

        int index = (int)((scrollTop - PadHeight + ContainerCenter - 30) / ItemHeight);

        if (index >= 0 && index < Days.Count)
        {
            SelectedDay = Days[index];
            DateService.SetDay(SelectedDay);
            StateHasChanged();
        }
    }


    async Task ResetToToday()
    {
        SelectedDay = Today;
        DateService.SetDay(Today);
        await ScrollToDay(Today);
    }

    void StartSession()
    {
        Console.WriteLine($"Logged day {SelectedDay}");
    }
}
