@page "/"
@inject IJSRuntime JS

<div class="calendar-wrapper">

    <div class="glow-beam"></div>

    <!-- Scroll wheel -->
    <div class="wheel-container" @onscroll="OnScroll" @ref="WheelRef">

        <!-- Top padding for centering -->
        <div style="height:180px"></div>

        @foreach (var day in Days)
        {
            <div class="wheel-item @(day == SelectedDay ? "selected" : "")">
                @day
            </div>
        }

        <!-- Bottom padding -->
        <div style="height:180px"></div>
    </div>

    <div class="start-bubble">
        <button class="start-button" @onclick="StartSession">Start</button>
    </div>

</div>

@code {
    ElementReference WheelRef;

    List<int> Days = Enumerable.Range(1, 31).ToList();
    int SelectedDay = 1; 

    const int ItemHeight = 60;
    const int PadHeight = 180; // top + bottom pad
    const int ContainerCenter = 210; // half of 420px

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Get correct Sweden date
            try
            {
                SelectedDay = await JS.InvokeAsync<int>("getClientDate");
            }
            catch
            {
                SelectedDay = DateTime.Now.Day;
            }


            int index = SelectedDay - 1;

            
            int scrollPosition =
                PadHeight +
                (index * ItemHeight) -
                (ContainerCenter - (ItemHeight / 2));

            await JS.InvokeVoidAsync("scrollToDay", WheelRef, scrollPosition);

            StateHasChanged();
        }
    }
    async void OnScroll()
    {
        int scrollTop = 0;

        try
        {
            scrollTop = await JS.InvokeAsync<int>("getScrollTop", WheelRef);
        }
        catch
        {
            scrollTop = 0; // fallback, never let the exception bubble
        }

        int index = (scrollTop - PadHeight + ContainerCenter - (ItemHeight / 2)) / ItemHeight;

        if (index >= 0 && index < Days.Count)
        {
            SelectedDay = Days[index];
            await InvokeAsync(StateHasChanged);
        }
    }



    void StartSession()
    {
        Console.WriteLine($"Starting session on day {SelectedDay}");
    }
}
